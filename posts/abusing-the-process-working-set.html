<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"/><link rel="preload" href="/fonts/Inter-roman.latin.var.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><title>Abusing the Process Working Set</title><meta name="next-head-count" content="5"/><meta name="robots" content="follow, index"/><meta name="description" content="Learn all about software development and reverse engineering."/><meta property="og:site_name" content="Atrexus&#x27;s Blog"/><meta property="og:description" content="Learn all about software development and reverse engineering."/><meta property="og:title" content="Atrexus&#x27;s Blog"/><meta property="og:image"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@atrexuss"/><meta name="twitter:title" content="Atrexus&#x27;s Blog"/><meta name="twitter:description" content="Learn all about software development and reverse engineering."/><meta name="twitter:image"/><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/><link rel="icon" href="/favicon.ico" type="image/x-icon"/><link rel="preload" href="/_next/static/css/51cc94077e73b6a3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/51cc94077e73b6a3.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-70187573dbb2adba.js" defer=""></script><script src="/_next/static/chunks/pages/_app-10575901b8aee3db.js" defer=""></script><script src="/_next/static/chunks/13-49892e2750e3d0f6.js" defer=""></script><script src="/_next/static/chunks/pages/posts/abusing-the-process-working-set-84a7f5719ff672c7.js" defer=""></script><script src="/_next/static/OlEVU4y09lCFfjQYFaVYU/_buildManifest.js" defer=""></script><script src="/_next/static/OlEVU4y09lCFfjQYFaVYU/_ssgManifest.js" defer=""></script></head><body><div id="__next"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><article class="nx-container nx-prose-sm dark:nx-prose-dark md:nx-prose" dir="ltr"><h1>Abusing the Process Working Set</h1><div class="nx-mb-8 nx-flex nx-gap-3 nx-items-center"><div class="nx-grow nx-text-gray-400"><div class="nx-not-prose nx-flex nx-flex-wrap nx-items-center nx-gap-1"><time dateTime="2024-09-10T13:28:19.051Z">Tue Sep 10 2024</time>  •  <a class="
          nx-select-none
          nx-rounded-md
          nx-bg-gray-200
          nx-px-1
          nx-text-sm
          nx-text-gray-400
          nx-transition-colors
          hover:nx-bg-gray-300
          hover:nx-text-gray-500
          dark:nx-bg-gray-600
          dark:nx-text-gray-300
          dark:hover:nx-bg-gray-700
          dark:hover:nx-text-gray-200
        " href="/tags/windows">windows</a><a class="
          nx-select-none
          nx-rounded-md
          nx-bg-gray-200
          nx-px-1
          nx-text-sm
          nx-text-gray-400
          nx-transition-colors
          hover:nx-bg-gray-300
          hover:nx-text-gray-500
          dark:nx-bg-gray-600
          dark:nx-text-gray-300
          dark:hover:nx-bg-gray-700
          dark:hover:nx-text-gray-200
        " href="/tags/x64">x64</a><a class="
          nx-select-none
          nx-rounded-md
          nx-bg-gray-200
          nx-px-1
          nx-text-sm
          nx-text-gray-400
          nx-transition-colors
          hover:nx-bg-gray-300
          hover:nx-text-gray-500
          dark:nx-bg-gray-600
          dark:nx-text-gray-300
          dark:hover:nx-bg-gray-700
          dark:hover:nx-text-gray-200
        " href="/tags/c++">c++</a></div></div><div class="nx-flex nx-items-center nx-gap-3"><a href="/">Back</a><span role="button" aria-label="Toggle Dark Mode" class="nx-cursor-pointer nx-p-2 nx-text-current" tabindex="0"><svg fill="none" viewBox="3 3 18 18" width="12" height="12" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" fill="currentColor" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></span></div></div><h2 class="subheading-h2">Understanding the Working Set in Windows<span class="nx-absolute -nx-mt-7" id="understanding-the-working-set-in-windows"></span><a href="#understanding-the-working-set-in-windows" class="subheading-anchor" aria-label="Permalink for this section"></a></h2>
<p>The <strong>working set</strong> of a Windows process refers to the collection of pages in its virtual address space that the process has recently referenced. This set includes shared data, such as libraries used by multiple processes and private dat unique to the process. The virtual memory manager optimizes performance by keeping only the necessary pages in memory, minimizing the overall demand on physical memory.</p>
<p>The virtual memory system in Windows is designed to balance efficiency and resource usage. By maintaining a working set, the system can avoid loading all possible pages into memory. This selective loading process ensures that memory is available for other processes and tasks, making the system more responsive.</p>
<p>However, not all memory pages are kept in the working set at all times. Pages that haven’t been used recently may be <strong>paged out</strong> to disk to free up memory for more active processes. When the application needs to access this paged-out memory unexpectedly, a <strong>page fault</strong> occurs.</p>
<h3 class="subheading-h3">What is a Page Fault?<span class="nx-absolute -nx-mt-7" id="what-is-a-page-fault"></span><a href="#what-is-a-page-fault" class="subheading-anchor" aria-label="Permalink for this section"></a></h3>
<p>A <strong>page fault</strong> happens when a process attempts to access a page not currently loaded into its working set. When this occurs, the operating system pauses the process, retrieves the required page from the disk, and loads it back into memory. Although this mechanism allows the system to manage memory efficiently, frequent page faults can degrade performance since accessing data from disk is slower than accessing it from memory.</p>
<h3 class="subheading-h3">Detecting Page Faults<span class="nx-absolute -nx-mt-7" id="detecting-page-faults"></span><a href="#detecting-page-faults" class="subheading-anchor" aria-label="Permalink for this section"></a></h3>
<p>Now that we understand what a <strong>page fault</strong> is, the next question is: how can we detect when one occurs? Fortunately, Windows provides tools to help us monitor memory activity. One such tool is the <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">GetWsChanges</code> function in the Windows API. This function allows us to retrieve information about the pages that have been added to or removed from the working set of a specified process since its initialization.</p>
<p>Below is a C++ implementation of a <strong>working set watcher</strong>. It uses <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">GetWsChangesEx</code> to gather the list of pages that have been added to or removed from the working set of the monitored process. It then checks if any of the faulting addresses are part of a predefined watch list and logs the details, including the thread ID and process information.</p>
<div data-rehype-pretty-code-fragment=""><div class="nx-not-prose"><pre class="nx-bg-primary-700/5 nx-mb-4 nx-overflow-x-auto nx-rounded-xl nx-font-medium nx-subpixel-antialiased dark:nx-bg-primary-300/10 nx-text-[.9em] contrast-more:nx-border contrast-more:nx-border-primary-900/20 contrast-more:nx-contrast-150 contrast-more:dark:nx-border-primary-100/40 nx-py-4 " data-language="cpp" data-theme="default"><code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr" data-language="cpp" data-theme="default"><span class="line"><span style="color:var(--shiki-token-keyword)">void</span><span style="color:var(--shiki-color-text)"> watcher</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">watch</span><span style="color:var(--shiki-color-text)">( std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">stop_token</span><span style="color:var(--shiki-color-text)"> token ) </span><span style="color:var(--shiki-token-keyword)">const</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">{</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">    std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-color-text)">vector</span><span style="color:var(--shiki-token-keyword)">&lt;</span><span style="color:var(--shiki-color-text)"> PSAPI_WS_WATCH_INFORMATION_EX </span><span style="color:var(--shiki-token-keyword)">&gt;</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-function)">buffer</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-constant)">100</span><span style="color:var(--shiki-color-text)"> );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-color-text)">    </span><span style="color:var(--shiki-token-keyword)">while</span><span style="color:var(--shiki-color-text)"> ( </span><span style="color:var(--shiki-token-keyword)">!</span><span style="color:var(--shiki-token-constant)">token</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-function)">stop_requested</span><span style="color:var(--shiki-color-text)">( ) )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">    {</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        </span><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">auto</span><span style="color:var(--shiki-color-text)"> size </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-constant)">buffer</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-function)">size</span><span style="color:var(--shiki-color-text)">( );</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        </span><span style="color:var(--shiki-token-keyword)">auto</span><span style="color:var(--shiki-color-text)"> cb </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">static_cast&lt;</span><span style="color:var(--shiki-color-text)"> DWORD </span><span style="color:var(--shiki-token-keyword)">&gt;</span><span style="color:var(--shiki-color-text)">( size </span><span style="color:var(--shiki-token-keyword)">*</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">sizeof</span><span style="color:var(--shiki-color-text)">( PSAPI_WS_WATCH_INFORMATION_EX ) );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">        // Clear the buffer and resize it to the required size.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        </span><span style="color:var(--shiki-token-constant)">buffer</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-function)">clear</span><span style="color:var(--shiki-color-text)">( );</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        </span><span style="color:var(--shiki-token-constant)">buffer</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-function)">resize</span><span style="color:var(--shiki-color-text)">( size );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-color-text)">        </span><span style="color:var(--shiki-token-keyword)">if</span><span style="color:var(--shiki-color-text)"> ( </span><span style="color:var(--shiki-token-keyword)">!</span><span style="color:var(--shiki-token-function)">GetWsChangesEx</span><span style="color:var(--shiki-color-text)">( handle</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-constant)">buffer</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-function)">data</span><span style="color:var(--shiki-color-text)">( )</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">&amp;</span><span style="color:var(--shiki-color-text)">cb ) )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        {</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            </span><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">auto</span><span style="color:var(--shiki-color-text)"> error </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-function)">GetLastError</span><span style="color:var(--shiki-color-text)">( );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">            // This isn&#x27;t an error, just no changes in the working set since the last call.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            </span><span style="color:var(--shiki-token-keyword)">if</span><span style="color:var(--shiki-color-text)"> ( error </span><span style="color:var(--shiki-token-keyword)">==</span><span style="color:var(--shiki-color-text)"> ERROR_NO_MORE_ITEMS )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            {</span></span>
<span class="line"><span style="color:var(--shiki-token-comment)">                // Wait a bit until we try again</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-color-text)">this_thread</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">sleep_for</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-constant)">1</span><span style="color:var(--shiki-token-keyword)">s</span><span style="color:var(--shiki-color-text)"> );</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                </span><span style="color:var(--shiki-token-keyword)">continue</span><span style="color:var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            }</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">            // Any other error code is a real error.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            </span><span style="color:var(--shiki-token-keyword)">if</span><span style="color:var(--shiki-color-text)"> ( error </span><span style="color:var(--shiki-token-keyword)">!=</span><span style="color:var(--shiki-color-text)"> ERROR_INSUFFICIENT_BUFFER )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                </span><span style="color:var(--shiki-token-keyword)">throw</span><span style="color:var(--shiki-color-text)"> std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">runtime_error</span><span style="color:var(--shiki-color-text)">( std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">format</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-string-expression)">&quot;Failed to get working set changes: {0}&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> error ) );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">            // Resize the buffer to the required size.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            </span><span style="color:var(--shiki-token-constant)">buffer</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-function)">resize</span><span style="color:var(--shiki-color-text)">( cb </span><span style="color:var(--shiki-token-keyword)">/</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">sizeof</span><span style="color:var(--shiki-color-text)">( PSAPI_WS_WATCH_INFORMATION_EX ) );</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            </span><span style="color:var(--shiki-token-keyword)">continue</span><span style="color:var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        }</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">        // At this point, we have an array of pages that have been added or removed from the working set. Now </span></span>
<span class="line"><span style="color:var(--shiki-token-comment)">        // lets see if we have a page that we care about.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        </span><span style="color:var(--shiki-token-keyword)">for</span><span style="color:var(--shiki-color-text)"> ( </span><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">auto&amp;</span><span style="color:var(--shiki-color-text)"> entry </span><span style="color:var(--shiki-token-punctuation)">:</span><span style="color:var(--shiki-color-text)"> buffer )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        {</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            </span><span style="color:var(--shiki-token-keyword)">if</span><span style="color:var(--shiki-color-text)"> ( </span><span style="color:var(--shiki-token-constant)">entry</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-constant)">BasicInfo</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-color-text)">FaultingPc </span><span style="color:var(--shiki-token-keyword)">==</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-constant)">nullptr</span><span style="color:var(--shiki-color-text)"> )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                </span><span style="color:var(--shiki-token-keyword)">continue</span><span style="color:var(--shiki-color-text)">;</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-color-text)">            </span><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">auto</span><span style="color:var(--shiki-color-text)"> faulting_va </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">reinterpret_cast&lt;</span><span style="color:var(--shiki-color-text)"> std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-keyword)">uintptr_t</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">&gt;</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-constant)">entry</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-constant)">BasicInfo</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-color-text)">FaultingVa );</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            </span><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">auto</span><span style="color:var(--shiki-color-text)"> faulting_page_va </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-function)">page_align</span><span style="color:var(--shiki-color-text)">( faulting_va );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">            // Check if the current page is in the watch list.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            </span><span style="color:var(--shiki-token-keyword)">if</span><span style="color:var(--shiki-color-text)"> ( std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">find</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-constant)">watch_list</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-function)">begin</span><span style="color:var(--shiki-color-text)">( )</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-constant)">watch_list</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-function)">end</span><span style="color:var(--shiki-color-text)">( )</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> faulting_page_va ) </span><span style="color:var(--shiki-token-keyword)">!=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-constant)">watch_list</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-function)">end</span><span style="color:var(--shiki-color-text)">( ) )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            {</span></span>
<span class="line"><span style="color:var(--shiki-token-comment)">                // Get the the process id of the thread that caused the fault.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                </span><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">auto</span><span style="color:var(--shiki-color-text)"> pid </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-function)">get_process_id</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-constant)">entry</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-color-text)">FaultingThreadId );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">                // If this is our process, then we can ignore it.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                </span><span style="color:var(--shiki-token-keyword)">if</span><span style="color:var(--shiki-color-text)"> ( pid </span><span style="color:var(--shiki-token-keyword)">==</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-function)">GetCurrentProcessId</span><span style="color:var(--shiki-color-text)">( ) )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                    </span><span style="color:var(--shiki-token-keyword)">continue</span><span style="color:var(--shiki-color-text)">;</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">                // Print the faulting PC and the faulting VA.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">println</span><span style="color:var(--shiki-color-text)">(</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                    </span><span style="color:var(--shiki-token-string-expression)">&quot;[+] 0x{:x} (0x{:x}) was mapped by (TID: {}) @ {}&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                    faulting_page_va</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                    faulting_va</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                    </span><span style="color:var(--shiki-token-constant)">entry</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-color-text)">FaultingThreadId</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                    </span><span style="color:var(--shiki-token-constant)">entry</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-constant)">BasicInfo</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-color-text)">FaultingPc );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">                // Get the process path.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                </span><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">auto</span><span style="color:var(--shiki-color-text)"> path </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-function)">get_process_path</span><span style="color:var(--shiki-color-text)">( pid );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">                // Print the process path.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">                std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">printf</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-string-expression)">&quot;\t--&gt; %ws (PID: </span><span style="color:var(--shiki-token-constant)">%lu</span><span style="color:var(--shiki-token-string-expression)">)\n&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-constant)">path</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-function)">c_str</span><span style="color:var(--shiki-color-text)">( )</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> pid );</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            }</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        }</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">        // Wait a bit until we try again</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-color-text)">this_thread</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">sleep_for</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-constant)">1</span><span style="color:var(--shiki-token-keyword)">s</span><span style="color:var(--shiki-color-text)"> );</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">    }</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">}</span></span></code></pre><div class="nx-opacity-0 nx-transition [div:hover&gt;&amp;]:nx-opacity-100 focus-within:nx-opacity-100 nx-flex nx-gap-1 nx-absolute nx-m-[11px] nx-right-0 nx-top-0"><button class="nextra-button nx-transition-all active:nx-opacity-50 nx-bg-primary-700/5 nx-border nx-border-black/5 nx-text-gray-600 hover:nx-text-gray-900 nx-rounded-md nx-p-1.5 dark:nx-bg-primary-300/10 dark:nx-border-white/10 dark:nx-text-gray-400 dark:hover:nx-text-gray-50 md:nx-hidden" title="Toggle word wrap"><svg viewBox="0 0 24 24" width="24" height="24" class="nx-pointer-events-none nx-h-4 nx-w-4"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div></div></div>
<blockquote>
<p>This code is part of the loop body for a <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">std::jthread</code> which is why it has a stop token.</p>
</blockquote>
<h3 class="subheading-h3">Creating and Managing Allocation<span class="nx-absolute -nx-mt-7" id="creating-and-managing-allocation"></span><a href="#creating-and-managing-allocation" class="subheading-anchor" aria-label="Permalink for this section"></a></h3>
<p>In the example above, the <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">watch_list</code> contains a list of virtual addresses corresponding to memory pages that should not be paged back into the working set. These allocations are crucial for ensuring that specific memory regions remain outside the working set, reducing their impact on system performance and memory pressure.</p>
<p>To achieve this, all allocations referenced in the <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">watch_list</code> must be created using the <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">VirtualAlloc</code> function, a Windows API method that allows you to allocate memory in a process’s virtual address space. <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">VirtualAlloc</code> provides control over the allocation size, memory protection, and type, allowing the creation of memory regions that can later be managed for paging.</p>
<p>Once these allocations are made, the pages need to be <em>paged out</em> of the working set. This can be done by calling the <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">VirtualUnlock</code> function on the allocated memory region. <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">VirtualUnlock</code> removes the specified pages from the process&#x27;s working set, forcing them to reside in the page file on disk rather than in physical memory. This prevents the pages from being accessed directly until they are paged back in as needed by the system.</p>
<div data-rehype-pretty-code-fragment=""><div class="nx-not-prose"><pre class="nx-bg-primary-700/5 nx-mb-4 nx-overflow-x-auto nx-rounded-xl nx-font-medium nx-subpixel-antialiased dark:nx-bg-primary-300/10 nx-text-[.9em] contrast-more:nx-border contrast-more:nx-border-primary-900/20 contrast-more:nx-contrast-150 contrast-more:dark:nx-border-primary-100/40 nx-py-4 " data-language="cpp" data-theme="default"><code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr" data-language="cpp" data-theme="default"><span class="line"><span style="color:var(--shiki-token-keyword)">template</span><span style="color:var(--shiki-color-text)">&lt; </span><span style="color:var(--shiki-token-keyword)">typename</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-function)">T</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">typename</span><span style="color:var(--shiki-color-text)">... </span><span style="color:var(--shiki-token-function)">Args</span><span style="color:var(--shiki-color-text)"> &gt;</span></span>
<span class="line"><span style="color:var(--shiki-token-function)">paged_ptr</span><span style="color:var(--shiki-color-text)">&lt; </span><span style="color:var(--shiki-token-function)">T</span><span style="color:var(--shiki-color-text)"> &gt; </span><span style="color:var(--shiki-token-function)">make_paged</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-function)">Args</span><span style="color:var(--shiki-token-keyword)">&amp;&amp;</span><span style="color:var(--shiki-color-text)">... args )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">{</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">    </span><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">auto</span><span style="color:var(--shiki-color-text)"> buffer </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-function)">VirtualAlloc</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-constant)">nullptr</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">sizeof</span><span style="color:var(--shiki-color-text)">( T )</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> MEM_COMMIT </span><span style="color:var(--shiki-token-keyword)">|</span><span style="color:var(--shiki-color-text)"> MEM_RESERVE</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> PAGE_EXECUTE_READWRITE );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-color-text)">    </span><span style="color:var(--shiki-token-keyword)">if</span><span style="color:var(--shiki-color-text)"> ( </span><span style="color:var(--shiki-token-keyword)">!</span><span style="color:var(--shiki-color-text)">buffer )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        </span><span style="color:var(--shiki-token-keyword)">throw</span><span style="color:var(--shiki-color-text)"> std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">bad_alloc</span><span style="color:var(--shiki-color-text)">( );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-color-text)">    </span><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">auto</span><span style="color:var(--shiki-color-text)"> instance </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">new</span><span style="color:var(--shiki-color-text)"> ( buffer ) </span><span style="color:var(--shiki-token-function)">T</span><span style="color:var(--shiki-color-text)">( std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">forward</span><span style="color:var(--shiki-color-text)">&lt; </span><span style="color:var(--shiki-token-function)">Args</span><span style="color:var(--shiki-color-text)"> &gt;( args )... );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-color-text)">    </span><span style="color:var(--shiki-token-keyword)">return</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-function)">paged_ptr</span><span style="color:var(--shiki-color-text)">&lt; </span><span style="color:var(--shiki-token-function)">T</span><span style="color:var(--shiki-color-text)"> &gt;( instance );</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">}</span></span></code></pre><div class="nx-opacity-0 nx-transition [div:hover&gt;&amp;]:nx-opacity-100 focus-within:nx-opacity-100 nx-flex nx-gap-1 nx-absolute nx-m-[11px] nx-right-0 nx-top-0"><button class="nextra-button nx-transition-all active:nx-opacity-50 nx-bg-primary-700/5 nx-border nx-border-black/5 nx-text-gray-600 hover:nx-text-gray-900 nx-rounded-md nx-p-1.5 dark:nx-bg-primary-300/10 dark:nx-border-white/10 dark:nx-text-gray-400 dark:hover:nx-text-gray-50 md:nx-hidden" title="Toggle word wrap"><svg viewBox="0 0 24 24" width="24" height="24" class="nx-pointer-events-none nx-h-4 nx-w-4"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div></div></div>
<p>In the code snippet above, we allocate memory, ensuring that the region is reserved in the virtual address space and committed in physical memory. Below is the implementation for the constructor of the <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">ws::paged_ptr</code> instance. This constructor is responsible for managing the allocation and ensuring the memory starts outside of the working set.</p>
<p>The key part of this design is that we use <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">VirtualUnlock</code> during the construction phase to remove the memory page from the working set, making sure it&#x27;s paged out. This ensures the page won’t be in physical memory immediately after allocation, allowing the operating system to manage it based on usage patterns. Additionally, the memory is added to the watch list, so future accesses can be tracked for changes.</p>
<div data-rehype-pretty-code-fragment=""><div class="nx-not-prose"><pre class="nx-bg-primary-700/5 nx-mb-4 nx-overflow-x-auto nx-rounded-xl nx-font-medium nx-subpixel-antialiased dark:nx-bg-primary-300/10 nx-text-[.9em] contrast-more:nx-border contrast-more:nx-border-primary-900/20 contrast-more:nx-contrast-150 contrast-more:dark:nx-border-primary-100/40 nx-py-4 " data-language="cpp" data-theme="default"><code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr" data-language="cpp" data-theme="default"><span class="line"><span style="color:var(--shiki-token-function)">paged_ptr</span><span style="color:var(--shiki-color-text)">( T</span><span style="color:var(--shiki-token-keyword)">*</span><span style="color:var(--shiki-color-text)"> instance ) : </span><span style="color:var(--shiki-token-function)">instance</span><span style="color:var(--shiki-color-text)">( instance )</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-function)">locked</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-constant)">false</span><span style="color:var(--shiki-color-text)"> )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">{</span></span>
<span class="line"><span style="color:var(--shiki-token-comment)">    // We initially unlock the memory so that the page is not in the working set.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">    </span><span style="color:var(--shiki-token-keyword)">if</span><span style="color:var(--shiki-color-text)"> ( instance )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        </span><span style="color:var(--shiki-token-function)">VirtualUnlock</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-keyword)">reinterpret_cast&lt;</span><span style="color:var(--shiki-color-text)"> LPVOID </span><span style="color:var(--shiki-token-keyword)">&gt;</span><span style="color:var(--shiki-color-text)">( instance )</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">sizeof</span><span style="color:var(--shiki-color-text)">( T ) );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">    // Add the instance to the watch list.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">    watcher</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">get</span><span style="color:var(--shiki-color-text)">( )</span><span style="color:var(--shiki-token-punctuation)">-&gt;</span><span style="color:var(--shiki-token-function)">add</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-keyword)">reinterpret_cast&lt;</span><span style="color:var(--shiki-color-text)"> std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-keyword)">uintptr_t</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">&gt;</span><span style="color:var(--shiki-color-text)">( instance ) );</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">}</span></span></code></pre><div class="nx-opacity-0 nx-transition [div:hover&gt;&amp;]:nx-opacity-100 focus-within:nx-opacity-100 nx-flex nx-gap-1 nx-absolute nx-m-[11px] nx-right-0 nx-top-0"><button class="nextra-button nx-transition-all active:nx-opacity-50 nx-bg-primary-700/5 nx-border nx-border-black/5 nx-text-gray-600 hover:nx-text-gray-900 nx-rounded-md nx-p-1.5 dark:nx-bg-primary-300/10 dark:nx-border-white/10 dark:nx-text-gray-400 dark:hover:nx-text-gray-50 md:nx-hidden" title="Toggle word wrap"><svg viewBox="0 0 24 24" width="24" height="24" class="nx-pointer-events-none nx-h-4 nx-w-4"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div></div></div>
<p>Now we need a way to safely access this memory. This is where the implementation of the <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">lock()</code> function. This function moves the memory into the working set and provides a shared pointer to access the memory safely. The design ensures that the memory is locked into the working set only when it is actually needed.</p>
<div data-rehype-pretty-code-fragment=""><div class="nx-not-prose"><pre class="nx-bg-primary-700/5 nx-mb-4 nx-overflow-x-auto nx-rounded-xl nx-font-medium nx-subpixel-antialiased dark:nx-bg-primary-300/10 nx-text-[.9em] contrast-more:nx-border contrast-more:nx-border-primary-900/20 contrast-more:nx-contrast-150 contrast-more:dark:nx-border-primary-100/40 nx-py-4 " data-language="cpp" data-theme="default"><code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr" data-language="cpp" data-theme="default"><span class="line"><span style="color:var(--shiki-token-comment)">/// &lt;summary&gt;</span></span>
<span class="line"><span style="color:var(--shiki-token-comment)">/// Moves the memory into the working set and returns a shared pointer to the memory. This is the only way to access the memory.</span></span>
<span class="line"><span style="color:var(--shiki-token-comment)">/// &lt;/summary&gt;</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">shared_ptr</span><span style="color:var(--shiki-color-text)">&lt; </span><span style="color:var(--shiki-token-function)">T</span><span style="color:var(--shiki-color-text)"> &gt; </span><span style="color:var(--shiki-token-function)">lock</span><span style="color:var(--shiki-color-text)">( ) </span><span style="color:var(--shiki-token-keyword)">const</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">{</span></span>
<span class="line"><span style="color:var(--shiki-token-comment)">    // If the current memory is not locked in the working set, we lock it.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">    </span><span style="color:var(--shiki-token-keyword)">if</span><span style="color:var(--shiki-color-text)"> ( </span><span style="color:var(--shiki-token-keyword)">!</span><span style="color:var(--shiki-color-text)">locked </span><span style="color:var(--shiki-token-keyword)">&amp;&amp;</span><span style="color:var(--shiki-color-text)"> instance )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">    {</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        </span><span style="color:var(--shiki-token-function)">VirtualLock</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-keyword)">reinterpret_cast&lt;</span><span style="color:var(--shiki-color-text)"> LPVOID </span><span style="color:var(--shiki-token-keyword)">&gt;</span><span style="color:var(--shiki-color-text)">( instance )</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">sizeof</span><span style="color:var(--shiki-color-text)">( T ) );</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        locked </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-constant)">true</span><span style="color:var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">    }</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-color-text)">    </span><span style="color:var(--shiki-token-keyword)">return</span><span style="color:var(--shiki-color-text)"> std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">shared_ptr</span><span style="color:var(--shiki-color-text)">&lt; </span><span style="color:var(--shiki-token-function)">T</span><span style="color:var(--shiki-color-text)"> &gt;(</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        instance</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        []( </span><span style="color:var(--shiki-token-function)">T</span><span style="color:var(--shiki-token-keyword)">*</span><span style="color:var(--shiki-color-text)"> ptr )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        {</span></span>
<span class="line"><span style="color:var(--shiki-token-comment)">            // Now we call virtual unlock twice: </span></span>
<span class="line"><span style="color:var(--shiki-token-comment)">            // 1. To unlock the memory.</span></span>
<span class="line"><span style="color:var(--shiki-token-comment)">            // 2. To remove the page from the working set.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            </span><span style="color:var(--shiki-token-function)">VirtualUnlock</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-keyword)">reinterpret_cast&lt;</span><span style="color:var(--shiki-color-text)"> LPVOID </span><span style="color:var(--shiki-token-keyword)">&gt;</span><span style="color:var(--shiki-color-text)">( ptr )</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">sizeof</span><span style="color:var(--shiki-color-text)">( T ) );</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">            </span><span style="color:var(--shiki-token-function)">VirtualUnlock</span><span style="color:var(--shiki-color-text)">( </span><span style="color:var(--shiki-token-keyword)">reinterpret_cast&lt;</span><span style="color:var(--shiki-color-text)"> LPVOID </span><span style="color:var(--shiki-token-keyword)">&gt;</span><span style="color:var(--shiki-color-text)">( ptr )</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">sizeof</span><span style="color:var(--shiki-color-text)">( T ) );</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">        } );</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">}</span></span></code></pre><div class="nx-opacity-0 nx-transition [div:hover&gt;&amp;]:nx-opacity-100 focus-within:nx-opacity-100 nx-flex nx-gap-1 nx-absolute nx-m-[11px] nx-right-0 nx-top-0"><button class="nextra-button nx-transition-all active:nx-opacity-50 nx-bg-primary-700/5 nx-border nx-border-black/5 nx-text-gray-600 hover:nx-text-gray-900 nx-rounded-md nx-p-1.5 dark:nx-bg-primary-300/10 dark:nx-border-white/10 dark:nx-text-gray-400 dark:hover:nx-text-gray-50 md:nx-hidden" title="Toggle word wrap"><svg viewBox="0 0 24 24" width="24" height="24" class="nx-pointer-events-none nx-h-4 nx-w-4"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div></div></div>
<p>We&#x27;ve created the <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">ws::paged_ptr</code> data type and can use it in our code. Assuming the working set watcher is running simultaneously on a separate thread, we can use the pointer like so:</p>
<div data-rehype-pretty-code-fragment=""><div class="nx-not-prose"><pre class="nx-bg-primary-700/5 nx-mb-4 nx-overflow-x-auto nx-rounded-xl nx-font-medium nx-subpixel-antialiased dark:nx-bg-primary-300/10 nx-text-[.9em] contrast-more:nx-border contrast-more:nx-border-primary-900/20 contrast-more:nx-contrast-150 contrast-more:dark:nx-border-primary-100/40 nx-py-4 " data-language="cpp" data-theme="default"><code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr" data-language="cpp" data-theme="default"><span class="line"><span style="color:var(--shiki-token-comment)">// Allocate a 10-byte array of paged memory</span></span>
<span class="line"><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">auto&amp;</span><span style="color:var(--shiki-color-text)"> paged </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> ws</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-function)">make_paged</span><span style="color:var(--shiki-color-text)">&lt; std</span><span style="color:var(--shiki-token-punctuation)">::</span><span style="color:var(--shiki-token-keyword)">uint8_t</span><span style="color:var(--shiki-color-text)"> &gt;( </span><span style="color:var(--shiki-token-constant)">10</span><span style="color:var(--shiki-color-text)"> );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">// Lock the page in memory so that we can safely access it&#x27;s data</span></span>
<span class="line"><span style="color:var(--shiki-token-keyword)">if</span><span style="color:var(--shiki-color-text)"> ( </span><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">auto&amp;</span><span style="color:var(--shiki-color-text)"> data </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-constant)">paged</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-function)">lock</span><span style="color:var(--shiki-color-text)">( ) )</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">{</span></span>
<span class="line"><span style="color:var(--shiki-token-comment)">    // Get the raw pointer to the data.</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">    </span><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">auto&amp;</span><span style="color:var(--shiki-color-text)"> ptr </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-constant)">data</span><span style="color:var(--shiki-token-punctuation)">.</span><span style="color:var(--shiki-token-function)">get</span><span style="color:var(--shiki-color-text)">( );</span></span>
<span class="line"> </span>
<span class="line"><span style="color:var(--shiki-token-comment)">    // Edit the memory</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">    </span><span style="color:var(--shiki-token-constant)">ptr</span><span style="color:var(--shiki-color-text)">[ </span><span style="color:var(--shiki-token-constant)">0</span><span style="color:var(--shiki-color-text)"> ] </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">0x</span><span style="color:var(--shiki-token-constant)">FF</span><span style="color:var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">    </span><span style="color:var(--shiki-token-constant)">ptr</span><span style="color:var(--shiki-color-text)">[ </span><span style="color:var(--shiki-token-constant)">1</span><span style="color:var(--shiki-color-text)"> ] </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-color-text)"> </span><span style="color:var(--shiki-token-keyword)">0x</span><span style="color:var(--shiki-token-constant)">FF</span><span style="color:var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color:var(--shiki-color-text)">}</span></span></code></pre><div class="nx-opacity-0 nx-transition [div:hover&gt;&amp;]:nx-opacity-100 focus-within:nx-opacity-100 nx-flex nx-gap-1 nx-absolute nx-m-[11px] nx-right-0 nx-top-0"><button class="nextra-button nx-transition-all active:nx-opacity-50 nx-bg-primary-700/5 nx-border nx-border-black/5 nx-text-gray-600 hover:nx-text-gray-900 nx-rounded-md nx-p-1.5 dark:nx-bg-primary-300/10 dark:nx-border-white/10 dark:nx-text-gray-400 dark:hover:nx-text-gray-50 md:nx-hidden" title="Toggle word wrap"><svg viewBox="0 0 24 24" width="24" height="24" class="nx-pointer-events-none nx-h-4 nx-w-4"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div></div></div>
<p>Our watcher captures all unauthorized access to memory protected by the <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">ws::paged_ptr</code> data type and logs it to the console. Below, I&#x27;ve attached a screenshot of such a scenario, where <a target="_blank" rel="noreferrer" href="https://github.com/ReClassNET/ReClass.NET">ReClass<span class="nx-sr-only"> (opens in a new tab)</span></a> attempts to read from a remote address in our process.</p>
<p><img alt="detection" src="/_next/static/media/dtc.4426c1d2.png" width="1115" height="323" decoding="async" data-nimg="1" loading="lazy" style="color:transparent;background-size:cover;background-position:50% 50%;background-repeat:no-repeat;background-image:url(&quot;data:image/svg+xml;charset=utf-8,%3Csvg xmlns=&#x27;http%3A//www.w3.org/2000/svg&#x27; viewBox=&#x27;0 0 8 2&#x27;%3E%3Cfilter id=&#x27;b&#x27; color-interpolation-filters=&#x27;sRGB&#x27;%3E%3CfeGaussianBlur stdDeviation=&#x27;1&#x27;/%3E%3C/filter%3E%3Cimage preserveAspectRatio=&#x27;none&#x27; filter=&#x27;url(%23b)&#x27; x=&#x27;0&#x27; y=&#x27;0&#x27; height=&#x27;100%25&#x27; width=&#x27;100%25&#x27; href=&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAACCAMAAABSSm3fAAAABlBMVEUZGRkKCgrW8oM4AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAADklEQVR4nGNggAFGKAAAADYACWw1PBEAAAAASUVORK5CYII=&#x27;/%3E%3C/svg%3E&quot;)"/></p>
<h2 class="subheading-h2">Conclusion<span class="nx-absolute -nx-mt-7" id="conclusion"></span><a href="#conclusion" class="subheading-anchor" aria-label="Permalink for this section"></a></h2>
<p>In this post, we explored the concept of the <strong>working set</strong> in Windows processes and how it plays a crucial role in efficient memory management. By understanding how memory pages are loaded into and removed from the working set, we can manipulate the system&#x27;s memory management mechanisms to monitor specific regions of memory for external access.</p>
<p>The <strong>working set watcher</strong> we implemented takes advantage of the <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">GetWsChangesEx</code> API to detect changes in the working set, allowing us to capture and log page faults triggered by external processes trying to access protected memory. This approach can be particularly useful in scenarios where securing memory from unauthorized access or external monitoring is critical, such as in anti-cheat systems, malware detection, or sensitive data protection.</p>
<p>Additionally, we introduced the <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">ws::paged_ptr</code> data type to manage memory more effectively, ensuring that specific pages remain outside the working set until explicitly needed. The integration of <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">VirtualLock</code> and <code class="nx-border-black nx-border-opacity-[0.04] nx-bg-opacity-[0.03] nx-bg-black nx-break-words nx-rounded-md nx-border nx-py-0.5 nx-px-[.25em] nx-text-[.9em] dark:nx-border-white/10 dark:nx-bg-white/10  " dir="ltr">VirtualUnlock</code> APIs allowed us to control when and how these pages are moved in and out of the working set, giving us more fine-grained control over memory access.</p>
<p>By combining these techniques, we can not only optimize memory usage but also detect unauthorized attempts to read or modify memory in real-time. This approach opens up possibilities for improving system security and performance in applications where memory management is critical. The <strong>working set</strong> can thus be &quot;abused&quot; in a controlled manner to gain visibility into memory access patterns and detect potential threats.</p>
<p>With tools like the <strong>working set watcher</strong> in place, we can protect critical memory regions and respond to unauthorized access quickly and effectively. This method adds an extra layer of monitoring and security in Windows applications.</p>
<p>For more details and to explore the code, this project is available via my GitHub: <a target="_blank" rel="noreferrer" href="https://github.com/atrexus/ws-watcher">ws-watcher<span class="nx-sr-only"> (opens in a new tab)</span></a>.</p><div class="my-24 mx-auto flex items-center sm:flex-row flex-col"><span class="inline-flex sm:ml-auto sm:mt-0 mt-4 justify-center sm:justify-start"><a target="_blank" href="https://github.com/atrexus" class="ml-3 text-gray-500"><svg stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path></svg></a><a target="_blank" href="https://twitter.com/atrexuss" class="ml-3 text-gray-500"><svg fill="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5" viewBox="0 0 24 24"><path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z"></path></svg></a></span></div></article></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/posts/abusing-the-process-working-set","query":{},"buildId":"OlEVU4y09lCFfjQYFaVYU","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>