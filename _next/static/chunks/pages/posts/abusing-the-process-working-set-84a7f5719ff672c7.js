(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4],{8233:function(s,e,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/abusing-the-process-working-set",function(){return n(9458)}])},250:function(s,e,n){"use strict";var o=n(5893);e.Z={footer:(0,o.jsx)("div",{className:"my-24 mx-auto flex items-center sm:flex-row flex-col",children:(0,o.jsxs)("span",{className:"inline-flex sm:ml-auto sm:mt-0 mt-4 justify-center sm:justify-start",children:[(0,o.jsx)("a",{target:"_blank",href:"https://github.com/atrexus",className:"ml-3 text-gray-500",children:(0,o.jsx)("svg",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",children:(0,o.jsx)("path",{d:"M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"})})}),(0,o.jsx)("a",{target:"_blank",href:"https://twitter.com/atrexuss",className:"ml-3 text-gray-500",children:(0,o.jsx)("svg",{fill:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",className:"w-5 h-5",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{d:"M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z"})})})]})}),unstable_faviconGlyph:"\uD83D\uDC4B",navs:[],darkMode:!0}},9458:function(s,e,n){"use strict";n.r(e),n.d(e,{default:function(){return d.ZP}});var o,r=n(5893),i=n(6871),l=n(250);n(7707);var t=n(1151),a=n(5675),c=n.n(a),h={src:"/_next/static/media/dtc.4426c1d2.png",height:323,width:1115,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAACCAMAAABSSm3fAAAABlBMVEUZGRkKCgrW8oM4AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAADklEQVR4nGNggAFGKAAAADYACWw1PBEAAAAASUVORK5CYII=",blurWidth:8,blurHeight:2},d=n(7505);let p={filePath:"pages/posts/abusing-the-process-working-set.mdx",route:"/posts/abusing-the-process-working-set",frontMatter:{title:"Abusing the Process Working Set",date:"2024-09-10T13:28:19.051Z",description:"This blog explores how the Windows process working set can be manipulated to detect external memory access using a custom working set watcher in C++.",tag:"windows, x64, c++"},pageMap:[{kind:"MdxPage",name:"index",route:"/",frontMatter:{type:"posts",title:"Home",description:"List of posts for the blog."}},{kind:"Folder",name:"posts",route:"/posts",children:[{kind:"MdxPage",name:"abusing-the-process-working-set",route:"/posts/abusing-the-process-working-set",frontMatter:{title:"Abusing the Process Working Set",date:"2024-09-10T13:28:19.051Z",description:"This blog explores how the Windows process working set can be manipulated to detect external memory access using a custom working set watcher in C++.",tag:"windows, x64, c++"}},{kind:"Meta",data:{"abusing-the-process-working-set":"Abusing the Process Working Set"}}]},{kind:"Folder",name:"tags",route:"/tags",children:[{kind:"MdxPage",name:"[tag]",route:"/tags/[tag]",frontMatter:{type:"tag",title:"Tagged Posts"}},{kind:"Meta",data:{"[tag]":"Tagged Posts"}}]},{kind:"Meta",data:{index:"Home",posts:"Posts",tags:"Tags"}}],headings:[{type:"heading",depth:2,children:[{type:"text",value:"Understanding the Working Set in Windows",position:{start:{line:2,column:4,offset:4},end:{line:2,column:44,offset:44}}}],position:{start:{line:2,column:1,offset:1},end:{line:2,column:44,offset:44}},value:"Understanding the Working Set in Windows"},{type:"heading",depth:3,children:[{type:"text",value:"What is a Page Fault?",position:{start:{line:10,column:5,offset:1054},end:{line:10,column:26,offset:1075}}}],position:{start:{line:10,column:1,offset:1050},end:{line:10,column:26,offset:1075}},value:"What is a Page Fault?"},{type:"heading",depth:3,children:[{type:"text",value:"Detecting Page Faults",position:{start:{line:14,column:5,offset:1513},end:{line:14,column:26,offset:1534}}}],position:{start:{line:14,column:1,offset:1509},end:{line:14,column:26,offset:1534}},value:"Detecting Page Faults"},{type:"heading",depth:3,children:[{type:"text",value:"Creating and Managing Allocation",position:{start:{line:98,column:5,offset:5260},end:{line:98,column:37,offset:5292}}}],position:{start:{line:98,column:1,offset:5256},end:{line:98,column:37,offset:5292}},value:"Creating and Managing Allocation"},{type:"heading",depth:2,children:[{type:"text",value:"Conclusion",position:{start:{line:187,column:4,offset:9989},end:{line:187,column:14,offset:9999}}}],position:{start:{line:187,column:1,offset:9986},end:{line:187,column:14,offset:9999}},value:"Conclusion"}],timestamp:1750029105e3,flexsearch:{codeblocks:!0}};function x(s){let e=Object.assign({h2:"h2",p:"p",strong:"strong",h3:"h3",code:"code",div:"div",pre:"pre",span:"span",blockquote:"blockquote",em:"em",a:"a"},(0,t.ah)(),s.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h2,{id:"understanding-the-working-set-in-windows",children:"Understanding the Working Set in Windows"}),"\n",(0,r.jsxs)(e.p,{children:["The ",(0,r.jsx)(e.strong,{children:"working set"})," of a Windows process refers to the collection of pages in its virtual address space that the process has recently referenced. This set includes shared data, such as libraries used by multiple processes and private dat unique to the process. The virtual memory manager optimizes performance by keeping only the necessary pages in memory, minimizing the overall demand on physical memory."]}),"\n",(0,r.jsx)(e.p,{children:"The virtual memory system in Windows is designed to balance efficiency and resource usage. By maintaining a working set, the system can avoid loading all possible pages into memory. This selective loading process ensures that memory is available for other processes and tasks, making the system more responsive."}),"\n",(0,r.jsxs)(e.p,{children:["However, not all memory pages are kept in the working set at all times. Pages that havenâ€™t been used recently may be ",(0,r.jsx)(e.strong,{children:"paged out"})," to disk to free up memory for more active processes. When the application needs to access this paged-out memory unexpectedly, a ",(0,r.jsx)(e.strong,{children:"page fault"})," occurs."]}),"\n",(0,r.jsx)(e.h3,{id:"what-is-a-page-fault",children:"What is a Page Fault?"}),"\n",(0,r.jsxs)(e.p,{children:["A ",(0,r.jsx)(e.strong,{children:"page fault"})," happens when a process attempts to access a page not currently loaded into its working set. When this occurs, the operating system pauses the process, retrieves the required page from the disk, and loads it back into memory. Although this mechanism allows the system to manage memory efficiently, frequent page faults can degrade performance since accessing data from disk is slower than accessing it from memory."]}),"\n",(0,r.jsx)(e.h3,{id:"detecting-page-faults",children:"Detecting Page Faults"}),"\n",(0,r.jsxs)(e.p,{children:["Now that we understand what a ",(0,r.jsx)(e.strong,{children:"page fault"})," is, the next question is: how can we detect when one occurs? Fortunately, Windows provides tools to help us monitor memory activity. One such tool is the ",(0,r.jsx)(e.code,{children:"GetWsChanges"})," function in the Windows API. This function allows us to retrieve information about the pages that have been added to or removed from the working set of a specified process since its initialization."]}),"\n",(0,r.jsxs)(e.p,{children:["Below is a C++ implementation of a ",(0,r.jsx)(e.strong,{children:"working set watcher"}),". It uses ",(0,r.jsx)(e.code,{children:"GetWsChangesEx"})," to gather the list of pages that have been added to or removed from the working set of the monitored process. It then checks if any of the faulting addresses are part of a predefined watch list and logs the details, including the thread ID and process information."]}),"\n",(0,r.jsx)(e.div,{"data-rehype-pretty-code-fragment":"",children:(0,r.jsx)(e.pre,{"data-language":"cpp","data-theme":"default",children:(0,r.jsxs)(e.code,{"data-language":"cpp","data-theme":"default",children:[(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"void"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" watcher"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"watch"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"stop_token"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" token ) "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"vector"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"<"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" PSAPI_WS_WATCH_INFORMATION_EX "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:">"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"buffer"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"100"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"while"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"!"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"token"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"stop_requested"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( ) )"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    {"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"auto"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" size "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"buffer"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"size"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( );"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"auto"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" cb "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"static_cast<"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" DWORD "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:">"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( size "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"*"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"sizeof"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( PSAPI_WS_WATCH_INFORMATION_EX ) );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"        // Clear the buffer and resize it to the required size."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"buffer"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"clear"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( );"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"buffer"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"resize"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( size );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"!"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"GetWsChangesEx"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( handle"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"buffer"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"data"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( )"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"&"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"cb ) )"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        {"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"auto"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" error "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"GetLastError"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"            // This isn't an error, just no changes in the working set since the last call."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ( error "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"=="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ERROR_NO_MORE_ITEMS )"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            {"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"                // Wait a bit until we try again"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"this_thread"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"sleep_for"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"s"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" );"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"continue"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"            // Any other error code is a real error."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ( error "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"!="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ERROR_INSUFFICIENT_BUFFER )"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"throw"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"runtime_error"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"format"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Failed to get working set changes: {0}"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" error ) );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"            // Resize the buffer to the required size."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"buffer"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"resize"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( cb "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"/"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"sizeof"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( PSAPI_WS_WATCH_INFORMATION_EX ) );"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"continue"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"        // At this point, we have an array of pages that have been added or removed from the working set. Now "})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"        // lets see if we have a page that we care about."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"for"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"auto&"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" entry "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" buffer )"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        {"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"entry"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"BasicInfo"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"FaultingPc "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"=="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"nullptr"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" )"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"continue"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"auto"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" faulting_va "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"reinterpret_cast<"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"uintptr_t"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:">"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"entry"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"BasicInfo"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"FaultingVa );"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"auto"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" faulting_page_va "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"page_align"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( faulting_va );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"            // Check if the current page is in the watch list."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ( std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"find"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"watch_list"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"begin"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( )"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"watch_list"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"end"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( )"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" faulting_page_va ) "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"!="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"watch_list"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"end"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( ) )"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            {"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"                // Get the the process id of the thread that caused the fault."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"auto"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" pid "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"get_process_id"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"entry"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"FaultingThreadId );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"                // If this is our process, then we can ignore it."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ( pid "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"=="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"GetCurrentProcessId"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( ) )"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"continue"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"                // Print the faulting PC and the faulting VA."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"println"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"("})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"[+] 0x{:x} (0x{:x}) was mapped by (TID: {}) @ {}"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    faulting_page_va"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    faulting_va"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"entry"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"FaultingThreadId"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"entry"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"BasicInfo"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"FaultingPc );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"                // Get the process path."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"auto"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" path "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"get_process_path"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( pid );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"                // Print the process path."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"                std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"printf"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"\\t--> %ws (PID: '}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"%lu"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:')\\n"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"path"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"c_str"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( )"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" pid );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"        // Wait a bit until we try again"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"this_thread"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"sleep_for"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"s"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})})}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsxs)(e.p,{children:["This code is part of the loop body for a ",(0,r.jsx)(e.code,{children:"std::jthread"})," which is why it has a stop token."]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"creating-and-managing-allocation",children:"Creating and Managing Allocation"}),"\n",(0,r.jsxs)(e.p,{children:["In the example above, the ",(0,r.jsx)(e.code,{children:"watch_list"})," contains a list of virtual addresses corresponding to memory pages that should not be paged back into the working set. These allocations are crucial for ensuring that specific memory regions remain outside the working set, reducing their impact on system performance and memory pressure."]}),"\n",(0,r.jsxs)(e.p,{children:["To achieve this, all allocations referenced in the ",(0,r.jsx)(e.code,{children:"watch_list"})," must be created using the ",(0,r.jsx)(e.code,{children:"VirtualAlloc"})," function, a Windows API method that allows you to allocate memory in a processâ€™s virtual address space. ",(0,r.jsx)(e.code,{children:"VirtualAlloc"})," provides control over the allocation size, memory protection, and type, allowing the creation of memory regions that can later be managed for paging."]}),"\n",(0,r.jsxs)(e.p,{children:["Once these allocations are made, the pages need to be ",(0,r.jsx)(e.em,{children:"paged out"})," of the working set. This can be done by calling the ",(0,r.jsx)(e.code,{children:"VirtualUnlock"})," function on the allocated memory region. ",(0,r.jsx)(e.code,{children:"VirtualUnlock"})," removes the specified pages from the process's working set, forcing them to reside in the page file on disk rather than in physical memory. This prevents the pages from being accessed directly until they are paged back in as needed by the system."]}),"\n",(0,r.jsx)(e.div,{"data-rehype-pretty-code-fragment":"",children:(0,r.jsx)(e.pre,{"data-language":"cpp","data-theme":"default",children:(0,r.jsxs)(e.code,{"data-language":"cpp","data-theme":"default",children:[(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"template"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"< "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"typename"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"T"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"typename"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"... "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"Args"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" >"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"paged_ptr"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"< "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"T"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" > "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"make_paged"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"Args"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"&&"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"... args )"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"auto"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" buffer "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"VirtualAlloc"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"nullptr"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"sizeof"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( T )"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" MEM_COMMIT "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"|"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" MEM_RESERVE"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" PAGE_EXECUTE_READWRITE );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"!"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"buffer )"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"throw"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"bad_alloc"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"auto"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" instance "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ( buffer ) "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"T"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"forward"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"< "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"Args"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" >( args )... );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"paged_ptr"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"< "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"T"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" >( instance );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})})}),"\n",(0,r.jsxs)(e.p,{children:["In the code snippet above, we allocate memory, ensuring that the region is reserved in the virtual address space and committed in physical memory. Below is the implementation for the constructor of the ",(0,r.jsx)(e.code,{children:"ws::paged_ptr"})," instance. This constructor is responsible for managing the allocation and ensuring the memory starts outside of the working set."]}),"\n",(0,r.jsxs)(e.p,{children:["The key part of this design is that we use ",(0,r.jsx)(e.code,{children:"VirtualUnlock"})," during the construction phase to remove the memory page from the working set, making sure it's paged out. This ensures the page wonâ€™t be in physical memory immediately after allocation, allowing the operating system to manage it based on usage patterns. Additionally, the memory is added to the watch list, so future accesses can be tracked for changes."]}),"\n",(0,r.jsx)(e.div,{"data-rehype-pretty-code-fragment":"",children:(0,r.jsx)(e.pre,{"data-language":"cpp","data-theme":"default",children:(0,r.jsxs)(e.code,{"data-language":"cpp","data-theme":"default",children:[(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"paged_ptr"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( T"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"*"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" instance ) : "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"instance"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( instance )"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"locked"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"false"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" )"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"    // We initially unlock the memory so that the page is not in the working set."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ( instance )"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"VirtualUnlock"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"reinterpret_cast<"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" LPVOID "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:">"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( instance )"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"sizeof"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( T ) );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"    // Add the instance to the watch list."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    watcher"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"get"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( )"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"->"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"add"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"reinterpret_cast<"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"uintptr_t"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:">"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( instance ) );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})})}),"\n",(0,r.jsxs)(e.p,{children:["Now we need a way to safely access this memory. This is where the implementation of the ",(0,r.jsx)(e.code,{children:"lock()"})," function. This function moves the memory into the working set and provides a shared pointer to access the memory safely. The design ensures that the memory is locked into the working set only when it is actually needed."]}),"\n",(0,r.jsx)(e.div,{"data-rehype-pretty-code-fragment":"",children:(0,r.jsx)(e.pre,{"data-language":"cpp","data-theme":"default",children:(0,r.jsxs)(e.code,{"data-language":"cpp","data-theme":"default",children:[(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"/// <summary>"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"/// Moves the memory into the working set and returns a shared pointer to the memory. This is the only way to access the memory."})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"/// </summary>"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"shared_ptr"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"< "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"T"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" > "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"lock"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( ) "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"    // If the current memory is not locked in the working set, we lock it."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"!"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"locked "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"&&"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" instance )"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    {"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"VirtualLock"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"reinterpret_cast<"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" LPVOID "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:">"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( instance )"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"sizeof"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( T ) );"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        locked "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"true"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"shared_ptr"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"< "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"T"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" >("})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        instance"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        []( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"T"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"*"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ptr )"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        {"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"            // Now we call virtual unlock twice: "})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"            // 1. To unlock the memory."})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"            // 2. To remove the page from the working set."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"VirtualUnlock"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"reinterpret_cast<"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" LPVOID "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:">"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( ptr )"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"sizeof"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( T ) );"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"VirtualUnlock"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"reinterpret_cast<"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" LPVOID "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:">"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( ptr )"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"sizeof"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( T ) );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        } );"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})})}),"\n",(0,r.jsxs)(e.p,{children:["We've created the ",(0,r.jsx)(e.code,{children:"ws::paged_ptr"})," data type and can use it in our code. Assuming the working set watcher is running simultaneously on a separate thread, we can use the pointer like so:"]}),"\n",(0,r.jsx)(e.div,{"data-rehype-pretty-code-fragment":"",children:(0,r.jsx)(e.pre,{"data-language":"cpp","data-theme":"default",children:(0,r.jsxs)(e.code,{"data-language":"cpp","data-theme":"default",children:[(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Allocate a 10-byte array of paged memory"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"auto&"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" paged "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ws"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"make_paged"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"< std"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"::"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"uint8_t"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" >( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"10"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"// Lock the page in memory so that we can safely access it's data"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ( "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"auto&"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" data "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"paged"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"lock"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( ) )"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"    // Get the raw pointer to the data."})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"auto&"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ptr "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"data"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-function)"},children:"get"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"( );"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:" "}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-comment)"},children:"    // Edit the memory"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"ptr"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"[ "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"0"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ] "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"0x"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"FF"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"ptr"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"[ "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" ] "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:"0x"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"FF"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})})}),"\n",(0,r.jsxs)(e.p,{children:["Our watcher captures all unauthorized access to memory protected by the ",(0,r.jsx)(e.code,{children:"ws::paged_ptr"})," data type and logs it to the console. Below, I've attached a screenshot of such a scenario, where ",(0,r.jsx)(e.a,{href:"https://github.com/ReClassNET/ReClass.NET",children:"ReClass"})," attempts to read from a remote address in our process."]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(c(),{alt:"detection",placeholder:"blur",src:h})}),"\n",(0,r.jsx)(e.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,r.jsxs)(e.p,{children:["In this post, we explored the concept of the ",(0,r.jsx)(e.strong,{children:"working set"})," in Windows processes and how it plays a crucial role in efficient memory management. By understanding how memory pages are loaded into and removed from the working set, we can manipulate the system's memory management mechanisms to monitor specific regions of memory for external access."]}),"\n",(0,r.jsxs)(e.p,{children:["The ",(0,r.jsx)(e.strong,{children:"working set watcher"})," we implemented takes advantage of the ",(0,r.jsx)(e.code,{children:"GetWsChangesEx"})," API to detect changes in the working set, allowing us to capture and log page faults triggered by external processes trying to access protected memory. This approach can be particularly useful in scenarios where securing memory from unauthorized access or external monitoring is critical, such as in anti-cheat systems, malware detection, or sensitive data protection."]}),"\n",(0,r.jsxs)(e.p,{children:["Additionally, we introduced the ",(0,r.jsx)(e.code,{children:"ws::paged_ptr"})," data type to manage memory more effectively, ensuring that specific pages remain outside the working set until explicitly needed. The integration of ",(0,r.jsx)(e.code,{children:"VirtualLock"})," and ",(0,r.jsx)(e.code,{children:"VirtualUnlock"})," APIs allowed us to control when and how these pages are moved in and out of the working set, giving us more fine-grained control over memory access."]}),"\n",(0,r.jsxs)(e.p,{children:["By combining these techniques, we can not only optimize memory usage but also detect unauthorized attempts to read or modify memory in real-time. This approach opens up possibilities for improving system security and performance in applications where memory management is critical. The ",(0,r.jsx)(e.strong,{children:"working set"}),' can thus be "abused" in a controlled manner to gain visibility into memory access patterns and detect potential threats.']}),"\n",(0,r.jsxs)(e.p,{children:["With tools like the ",(0,r.jsx)(e.strong,{children:"working set watcher"})," in place, we can protect critical memory regions and respond to unauthorized access quickly and effectively. This method adds an extra layer of monitoring and security in Windows applications."]}),"\n",(0,r.jsxs)(e.p,{children:["For more details and to explore the code, this project is available via my GitHub: ",(0,r.jsx)(e.a,{href:"https://github.com/atrexus/ws-watcher",children:"ws-watcher"}),"."]})]})}function k(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:e}=Object.assign({},(0,t.ah)(),s.components);return e?(0,r.jsx)(e,{...s,children:(0,r.jsx)(x,{...s})}):x(s)}globalThis.__nextra_internal__={pageMap:p.pageMap,route:p.route},p.title="Abusing the Process Working Set";let y=s=>(0,r.jsx)(i.mK.Provider,{value:s,children:(0,r.jsx)(k,{})});(o=globalThis).__nextra_pageContext__||(o.__nextra_pageContext__=Object.create(null)),globalThis.__nextra_pageContext__["/posts/abusing-the-process-working-set"]={Content:y,pageOpts:p,themeConfig:l.Z}}},function(s){s.O(0,[13,774,888,179],function(){return s(s.s=8233)}),_N_E=s.O()}]);